<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Board</title>
    <link rel="stylesheet" href="/static/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="/static/css/board.css"/>
</head>
<body>
    <div class="hud">
        <div class="brand">
            <i class="icon-globe"></i>
        </div>

        <div class="resource crowns" title="Energy sources conquered"><i class="icon-bolt"></i><span>1</span></div>
        <div class="resource forts" title="Habitable stars conquered"><i class="icon-star"></i><span>1</span></div>

        <div class="resource power" title="Energy credits available"><i class="icon-lightbulb"></i><span>5</span></div>
        <div class="resource supplies" title="Scrap available"><i class="icon-cog"></i><span>2</span></div>

        <div class="phase_title">
            <span></span>
        </div>

        <div class="tracks">
            <div class="resource raven" title="Spying track"><i class="icon-eye-open"></i><ul></ul></div>
            <div class="resource blade" title="Force track"><i class="icon-screenshot"></i><ul></ul></div>
            <div class="resource throne" title="Legalty track"><i class="icon-legal"></i><ul></ul></div>
        </div>
    </div>
    <div class="hud bottom">
        <ul class="orders"></ul>
        <ul class="units"></ul>
        <span class="power">power</span>
        <span class="done">done</span>
    </div>
    <div class="hud bottom2">
        <div class="fights"></div>
        <span class="done">done</span>
    </div>
    <div class="map_holder">
        <div id="map_container" style="
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0 auto;
        "></div>
    </div>
    <script src="/static/js/jquery-1.8.2.min.js"></script>
    <script src="/static/js/jquery.overscroll.js"></script>
    <script src="/static/js/jquery.hotkeys.js"></script>
    <script src="/static/js/jquery.mousewheel.js"></script>
    <script src="/static/js/raphael.js"></script>
    <script src="/static/js/raphael.panzoom.js"></script>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/common.js"></script>

    <script src="/static/js/glyph.js"></script>
    <script src="/static/js/path.js"></script>
    <script src="/static/js/map.js"></script>
    <script src="/static/js/hud_planning.js"></script>
    <script src="/static/js/ctrl_planning.js"></script>
    <script src="/static/js/hud_march.js"></script>
    <script src="/static/js/ctrl_march.js"></script>
    <script src="/static/js/hud_support.js"></script>
    <script src="/static/js/ctrl_support.js"></script>
    <script src="/static/js/hud_retreat.js"></script>
    <script src="/static/js/ctrl_retreat.js"></script>
    <script src="/static/js/systems.js"></script>
    <script src="/static/js/routes.js"></script>
    <script src="/static/js/hud.js"></script>
    <script>
        (function ($) {
            var auth = function () {
                var player = location_hash();
                if (!player) {
                    player = window.prompt("Enter your login and password");
                }
                var api = new API("/api.php");
                api.request("Auth", {"player": player}, function (rsp) {
                    if (rsp['result'] != "success") {
                        if (location_hash()) {
                            location_hash("");
                        } else {
                            alert("Our server don't like the data you provided. Please try again");
                        }
                        return auth();
                    }
                    location_hash(player);
                    var data = rsp['data'];
                    var house_id = data['house_id'];
                    api.request("GetEvent", {}, function (rsp) {
                        if (rsp['result'] != "success") {
                            alert("Something went wrong. Can't load event from API. Check debug console for details");
                            console.log(rsp);
                            return;
                        }
                        var data = rsp['data'];
                        var event = data['event'];
                        var state = data['state'];

                        var players = state['players'];
                        var current_player = players[house_id];
                        var tracks = state['tracks']['tracks'];

                        map.api = api;
                        map.state = state;
                        map.paper = Raphael('map_container');

                        map.current_player = current_player;
                        var world = map.parse(players, state['map']['regions']);
                        $(document).ready(function () {
                            world.draw();
                            hud.init(world, players, current_player);
                            hud.setupTracks(tracks);
                            world.setCtrl(event['phase'], event.data);

                            var on_resize = function () {
                                var w = $(window).width(), h = $(window).height();
                                $('.map_holder').width(w);
                                $('.map_holder').height(h);
                                map.paper.setSize(w, h);
                            };
                            $(window).resize(on_resize);
                            on_resize();

                            var pz = map.paper.panzoom({maxZoom: 7, minZoom: -10, initialZoom: 0});
                            pz.enable();
                        });
                    })
                });
            };
            auth();
        })(jQuery);
    </script>
</body>
</html>
